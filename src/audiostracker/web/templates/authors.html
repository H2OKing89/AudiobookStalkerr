<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiobook Stalkerr - Authors Management</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Manage your audiobook authors and track upcoming releases from your favorite authors. Add, remove, and organize authors in your Audiobook Stalkerr watchlist.">
    <meta name="keywords" content="audiobooks, authors, audiobook tracker, manage authors, audible, book tracking">
    <meta name="author" content="Audiobook Stalkerr">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:title" content="Audiobook Stalkerr - Authors Management">
    <meta property="og:description" content="Manage your audiobook authors and track upcoming releases from your favorite authors. Add, remove, and organize authors in your Audiobook Stalkerr watchlist.">
    <meta property="og:image" content="{{ request.url_for('static', path='images/og-image.png') }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Audiobook Stalkerr">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.url }}">
    <meta property="twitter:title" content="Audiobook Stalkerr - Authors Management">
    <meta property="twitter:description" content="Manage your audiobook authors and track upcoming releases from your favorite authors. Add, remove, and organize authors in your Audiobook Stalkerr watchlist.">
    <meta property="twitter:image" content="{{ request.url_for('static', path='images/twitter-card.png') }}">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#6366f1">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- Tabler CSS (includes Bootstrap and Tabler Icons) -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet"/>
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/2.0.0/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/3.0.0/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/3.0.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <!-- Font Awesome (keeping for compatibility with existing icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/themes.css">
    <link rel="stylesheet" href="/static/css/authors.css">
</head>
<body>
    <!-- Navigation -->
    <header class="navbar navbar-expand-md navbar-light d-print-none">
        <div class="container-xl">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                <a href="/">
                    <i class="fas fa-headphones text-primary me-2"></i>
                    Audiobook Stalkerr
                </a>
            </h1>
            <div class="navbar-nav flex-row order-md-last">
                <a href="#" class="nav-link px-0 hide-theme-dark" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts">
                    <i class="fas fa-keyboard me-1"></i>
                    <span class="d-none d-md-inline">Shortcuts</span>
                </a>
                <a href="#" class="nav-link px-0 hide-theme-dark ms-2" onclick="toggleSettingsPanel()" title="Settings">
                    <i class="fas fa-cogs me-1"></i>
                    <span class="d-none d-md-inline">Settings</span>
                </a>
                <a href="#" class="nav-link px-0 hide-theme-dark ms-2" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>
                    <span class="d-none d-md-inline">Refresh</span>
                </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <span class="nav-link-icon d-md-none d-lg-inline-block">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                                <span class="nav-link-title">Upcoming Releases</span>
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="/authors">
                                <span class="nav-link-icon d-md-none d-lg-inline-block">
                                    <i class="fas fa-users"></i>
                                </span>
                                <span class="nav-link-title">Authors</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Unsaved Changes Indicator -->
    <div id="unsaved-indicator" class="unsaved-indicator">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Unsaved Changes</span>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-panel-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Settings
                </h5>
                <button class="btn-close" onclick="toggleSettingsPanel()"></button>
            </div>
        </div>
        <div class="settings-panel-body">
            <div class="settings-group">
                <h6>Preferences</h6>
                <div class="setting-item">
                    <div>
                        <div class="fw-medium">Auto-save</div>
                        <small class="text-muted">Automatically save changes after 3 seconds</small>
                    </div>
                    <div class="auto-save-toggle" onclick="toggleAutoSave()">
                        <div id="auto-save-switch" class="auto-save-switch"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="fw-medium">Show completion status</div>
                        <small class="text-muted">Display completion indicators on book cards</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="show-completion" checked onchange="toggleCompletionStatus()">
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="fw-medium">Real-time validation</div>
                        <small class="text-muted">Validate required fields in real-time</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="real-time-validation" checked onchange="toggleRealtimeValidation()">
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <h6>View Options</h6>
                <div class="setting-item">
                    <div>
                        <div class="fw-medium">Cards per row</div>
                        <small class="text-muted">Number of author cards per row</small>
                    </div>
                    <select class="form-select form-select-sm" style="width: auto;" onchange="updateCardsPerRow(this.value)">
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="fw-medium">Compact mode</div>
                        <small class="text-muted">Use smaller cards and reduced spacing</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="compact-mode" onchange="toggleCompactMode()">
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <h6>Keyboard Shortcuts</h6>
                <div class="small text-muted">
                    <div class="d-flex justify-content-between py-1">
                        <span>Save changes</span>
                        <span><kbd>Ctrl</kbd> + <kbd>S</kbd></span>
                    </div>
                    <div class="d-flex justify-content-between py-1">
                        <span>Add author</span>
                        <span><kbd>Ctrl</kbd> + <kbd>A</kbd></span>
                    </div>
                    <div class="d-flex justify-content-between py-1">
                        <span>Search</span>
                        <span><kbd>Ctrl</kbd> + <kbd>F</kbd></span>
                    </div>
                    <div class="d-flex justify-content-between py-1">
                        <span>Toggle view mode</span>
                        <span><kbd>V</kbd></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel Backdrop -->
    <div id="settings-backdrop" class="settings-backdrop" onclick="toggleSettingsPanel()"></div>

    <!-- Main Content -->
    <div class="page-wrapper">
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <div class="page-pretitle">
                            Audiobook Management
                        </div>
                        <h2 class="page-title">
                            <i class="fas fa-users text-primary me-3"></i>
                            Authors Management
                        </h2>
                        <div class="text-muted mt-1">
                            Manage your audiobook authors watchlist. Add, remove, and organize authors whose upcoming releases you want to track.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="page-body">
            <div class="container-xl">

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Search and Filters Row -->
                        <div class="row align-items-center g-3 mb-3">
                            <div class="col-lg-5 col-md-12">
                                <div class="input-icon">
                                    <span class="input-icon-addon">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" id="search-input" class="form-control" 
                                           placeholder="Search authors and books...">
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <select id="publisher-filter" class="form-select">
                                    <option value="all">All Publishers</option>
                                </select>
                            </div>
                            <div class="col-lg-4 col-md-6">
                                <div class="d-flex justify-content-end justify-md-center justify-lg-end">
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="view-mode" id="grid-view" autocomplete="off" checked>
                                        <label class="btn btn-outline-secondary" for="grid-view" onclick="setViewMode('grid')" title="Grid View">
                                            <i class="fas fa-th"></i>
                                        </label>
                                        <input type="radio" class="btn-check" name="view-mode" id="table-view" autocomplete="off">
                                        <label class="btn btn-outline-secondary" for="table-view" onclick="setViewMode('table')" title="Table View">
                                            <i class="fas fa-table"></i>
                                        </label>
                                        <input type="radio" class="btn-check" name="view-mode" id="list-view" autocomplete="off">
                                        <label class="btn btn-outline-secondary" for="list-view" onclick="setViewMode('list')" title="List View">
                                            <i class="fas fa-list"></i>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons Row -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2 flex-wrap justify-content-center justify-lg-start">
                                    <button class="btn btn-primary" onclick="showAddAuthorModal()">
                                        <i class="fas fa-plus me-1"></i>Add Author
                                    </button>
                                    <button class="btn btn-warning save-changes-btn" onclick="window.app.saveChanges()" 
                                            title="Save All Changes" style="display: none;">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                    <button class="btn btn-danger" onclick="showManualStartConfirmation()" title="Manually run the audiobook search">
                                        <i class="fas fa-play me-1"></i>Manual Start Search
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportCollection()">
                                        <i class="fas fa-download me-1"></i>Export
                                    </button>
                                    <button class="btn btn-outline-info" onclick="showImportModal()">
                                        <i class="fas fa-upload me-1"></i>Import
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showStatsModal()" title="View Statistics">
                                        <i class="fas fa-chart-bar me-1"></i>Stats
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                <!-- Statistics Cards -->
                <div class="row row-deck row-cards mb-4" id="stats-cards">
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-success text-white avatar">
                                            <i class="fas fa-users"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="total-authors">
                                            {{ stats.total_authors }}
                                        </div>
                                        <div class="text-muted">
                                            Authors
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-info text-white avatar">
                                            <i class="fas fa-list"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="total-books">
                                            {{ stats.total_books }}
                                        </div>
                                        <div class="text-muted">
                                            Watch Entries
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-warning text-white avatar">
                                            <i class="fas fa-building"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="total-publishers">
                                            {{ stats.total_publishers }}
                                        </div>
                                        <div class="text-muted">
                                            Publishers
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-danger text-white avatar">
                                            <i class="fas fa-microphone"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="total-narrators">
                                            {{ stats.total_narrators }}
                                        </div>
                                        <div class="text-muted">
                                            Narrators
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Authors Table View (for large datasets) -->
                <div id="authors-table-container" class="card" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Authors & Books Management</h3>
                        <div class="card-actions">
                            <div class="dropdown">
                                <a href="#" class="btn-action dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-cog"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a class="dropdown-item" href="#" onclick="exportSelected()">
                                        <i class="fas fa-download me-2"></i>Export Selected
                                    </a>
                                    <a class="dropdown-item" href="#" onclick="deleteSelected()">
                                        <i class="fas fa-trash me-2"></i>Delete Selected
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <table id="authors-table" class="table table-striped table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all"></th>
                                    <th>Author</th>
                                    <th>Books</th>
                                    <th>Complete</th>
                                    <th>Publishers</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Authors Grid/Card Container (existing) -->
                <div id="authors-container" class="authors-grid">
                    <p>Loading authors...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showQuickAddModal()" title="Quick Add Book">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Modals -->
    <div id="modals-container">
        <!-- Modals will be dynamically loaded here -->
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal fade" id="keyboardShortcutsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body shortcuts-modal">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">General</h6>
                            <div class="shortcut-item">
                                <span>Save changes</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">Ctrl</span>
                                    <span class="shortcut-key">S</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Search</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">Ctrl</span>
                                    <span class="shortcut-key">F</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Toggle view mode</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">V</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Refresh data</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">F5</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Actions</h6>
                            <div class="shortcut-item">
                                <span>Add author</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">Ctrl</span>
                                    <span class="shortcut-key">A</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Quick add book</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">Ctrl</span>
                                    <span class="shortcut-key">B</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Export collection</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">Ctrl</span>
                                    <span class="shortcut-key">E</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Show settings</span>
                                <div class="shortcut-keys">
                                    <span class="shortcut-key">Ctrl</span>
                                    <span class="shortcut-key">,</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notification-toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Audiobook Stalkerr</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Message will be set by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Tabler JS (includes Bootstrap) -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/2.0.0/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.0/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.0/js/responsive.bootstrap5.min.js"></script>
    
    <!-- New Modular Architecture -->
    <!-- Core Framework -->
    <script src="/static/js/core/app-core.js"></script>
    <script src="/static/js/core/module-registry.js"></script>
    
    <!-- Core Modules -->
    <script src="/static/js/core/state.js"></script>
    <script src="/static/js/core/api-clean.js"></script>
    
    <!-- UI Modules -->
    <script src="/static/js/modules/toast-clean.js"></script>
    <script src="/static/js/modules/theme-clean.js"></script>
    <script src="/static/js/modules/search-clean.js"></script>
    <script src="/static/js/modules/filters-clean.js"></script>
    <script src="/static/js/modules/modals-clean.js"></script>
    <script src="/static/js/modules/validation-clean.js"></script>
    <script src="/static/js/modules/table-view-clean.js"></script>
    <script src="/static/js/modules/author-detail-clean.js"></script>
    
    <!-- Main Application -->
    <script src="/static/js/app-clean.js"></script>
    
    <!-- Application Bootstrap -->
    <script src="/static/js/bootstrap.js"></script>

    <!-- Initialize app data -->
    <script>
        // Initialize data for the application
        window.initialData = JSON.parse('{{ audiobooks|tojson|safe }}');
        window.initialStats = JSON.parse('{{ stats|tojson|safe }}');
        
        console.log('Initial data loaded:', {
            authors: window.initialData?.length || 0,
            stats: window.initialStats
        });
        
        // Manual Start functionality (legacy support)
        function showManualStartConfirmation() {
            if (confirm('Are you sure you want to manually run the audiobook search? This will search Audible for new releases from all configured authors and may take several minutes.')) {
                runManualStart();
            }
        }
        
        async function runManualStart() {
            try {
                // Show loading state
                if (typeof showLoading === 'function') {
                    showLoading(true);
                }
                
                if (window.appCore) {
                    window.appCore.notify('Starting manual audiobook search...', 'info');
                }
                
                const response = await fetch('/api/manual-start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (window.appCore) {
                        window.appCore.notify(result.message || 'Manual search completed successfully!', 'success');
                    }
                    // Refresh data if available
                    if (window.app && window.app.refreshData) {
                        setTimeout(() => window.app.refreshData(), 2000);
                    }
                } else {
                    throw new Error(result.error || 'Manual search failed');
                }
                
            } catch (error) {
                console.error('Manual start failed:', error);
                if (window.appCore) {
                    window.appCore.notify(`Manual search failed: ${error.message}`, 'error');
                }
            } finally {
                if (typeof showLoading === 'function') {
                    showLoading(false);
                }
            }
        }
        
        // Make functions available globally for HTML onclick handlers
        window.showManualStartConfirmation = showManualStartConfirmation;
        window.runManualStart = runManualStart;
    </script>

    <!-- Legacy compatibility script -->
    <script>
        // Enhanced setViewMode function to handle table view
        window.setViewMode = function(mode) {
            console.log('Setting view mode to:', mode);
            
            if (mode === 'table') {
                window.tableView?.show();
                document.getElementById('table-view')?.checked && (document.getElementById('table-view').checked = true);
            } else {
                window.tableView?.hide();
                if (window.app) {
                    window.app.setViewMode(mode);
                }
            }
            
            // Update active button state
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === mode) {
                    btn.classList.add('active');
                }
            });
        };

        // Check if modular architecture is initialized and if not, initialize legacy code
        document.addEventListener('DOMContentLoaded', function() {
            // If the app hasn't been initialized by the modular architecture
            if (!window.app) {
                console.log('Falling back to legacy initialization');
                try {
                    if (typeof AudiobookStalkerrAPI === 'function') {
                        window.api = new AudiobookStalkerrAPI();
                    }
                } catch (e) {
                    console.error('API initialization failed:', e);
                }
                
                if (typeof AudiobookStalkerrApp === 'function') {
                    try {
                        window.app = new AudiobookStalkerrApp();
                        window.app.init();
                        
                        // Load data into table view after a delay to ensure everything is ready
                        setTimeout(() => {
                            if (window.initialData && window.tableView) {
                                window.tableView.loadData(window.initialData);
                            }
                        }, 500);
                    } catch (e) {
                        console.error('App initialization failed:', e);
                    }
                }
            }
        });
    </script>
</body>
</html>
</html>
