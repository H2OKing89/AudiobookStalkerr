<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiobook Stalkerr - Upcoming Releases</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Track upcoming audiobook releases from your favorite authors. Never miss a new audiobook with Audiobook Stalkerr's release calendar and notifications.">
    <meta name="keywords" content="audiobooks, upcoming releases, audiobook tracker, release calendar, audible, book notifications">
    <meta name="author" content="Audiobook Stalkerr">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:title" content="Audiobook Stalkerr - Upcoming Audiobook Releases">
    <meta property="og:description" content="Track upcoming audiobook releases from your favorite authors. Never miss a new audiobook with Audiobook Stalkerr's release calendar and notifications.">
    <meta property="og:image" content="{{ request.url_for('static', path='images/og-image.png') }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Audiobook Stalkerr">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.url }}">
    <meta property="twitter:title" content="Audiobook Stalkerr - Upcoming Audiobook Releases">
    <meta property="twitter:description" content="Track upcoming audiobook releases from your favorite authors. Never miss a new audiobook with Audiobook Stalkerr's release calendar and notifications.">
    <meta property="twitter:image" content="{{ request.url_for('static', path='images/twitter-card.png') }}">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#6366f1">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://code.jquery.com">
    
    <!-- Tabler CSS (includes Bootstrap and Tabler Icons) -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet"/>
    <!-- Font Awesome (keeping for compatibility with existing icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/themes.css">
    <link rel="stylesheet" href="/static/css/upcoming.css">

    
    <!-- Accessibility CSS -->
    <style>
        /* Skip to content link */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: #fff;
            padding: 8px;
            text-decoration: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            transition: top 0.3s;
        }
        
        .skip-to-content:focus {
            top: 0;
        }
        
        /* Screen reader only content */
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }
        
        /* Loading overlay improvements */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .mobile-view .card-img-top {
                height: 150px !important;
            }
            
            .mobile-layout .btn-group {
                display: flex;
                flex-direction: column;
            }
            
            .mobile-layout .btn-group .btn {
                margin-bottom: 0.25rem;
            }
        }
        
        /* Focus management */
        :focus {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .card {
                border: 2px solid currentColor;
            }
            
            .badge {
                border: 1px solid currentColor;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Vue 3 specific styles */
        [v-cloak] { 
            display: none !important; 
        }
        
        /* Vue 3 transition classes */
        .v-enter-active,
        .v-leave-active {
            transition: opacity 300ms ease-in-out, transform 300ms ease-in-out;
        }
        
        .v-enter-from,
        .v-leave-to {
            opacity: 0;
            transform: scale(0.95);
        }
        
        .v-enter-to,
        .v-leave-from {
            opacity: 1;
            transform: scale(1);
        }
        
        /* Loading states for Vue */
        [v-show] {
            transition: opacity 300ms ease-in-out, transform 300ms ease-in-out;
        }
        
        /* Ensure smooth view mode transitions */
        .row-cards,
        .list-group {
            transition: opacity 250ms ease-in-out;
        }
        
        /* Filter badge transitions */
        .card-actions {
            transition: opacity 250ms ease-in-out, transform 250ms ease-in-out;
        }
    </style>
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    
    <!-- Navigation -->
    <header class="navbar navbar-expand-md navbar-light d-print-none" role="banner">
        <div class="container-xl">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" 
                    aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation menu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                <a href="/" aria-label="Audiobook Stalkerr - Go to home page">
                    <i class="fas fa-headphones text-primary me-2" aria-hidden="true"></i>
                    Audiobook Stalkerr
                </a>
            </h1>
            <div class="navbar-nav flex-row order-md-last">
                <button type="button" class="nav-link px-0 hide-theme-dark btn btn-link" 
                        @click="refreshData"
                        aria-label="Refresh upcoming audiobooks data">
                    <i class="fas fa-sync-alt me-1" aria-hidden="true"></i>
                    <span class="d-none d-md-inline">Refresh</span>
                </button>
            </div>
            <nav class="collapse navbar-collapse" id="navbar-menu" aria-label="Main navigation">
                <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
                    <ul class="navbar-nav" role="menubar">
                        <li class="nav-item" role="none">
                            <a class="nav-link active" href="/" role="menuitem" aria-current="page">
                                <span class="nav-link-icon d-md-none d-lg-inline-block" aria-hidden="true">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                                <span class="nav-link-title">Upcoming Releases</span>
                            </a>
                        </li>
                        <li class="nav-item" role="none">
                            <a class="nav-link" href="/analytics" role="menuitem">
                                <span class="nav-link-icon d-md-none d-lg-inline-block" aria-hidden="true">
                                    <i class="fas fa-chart-line"></i>
                                </span>
                                <span class="nav-link-title">Analytics</span>
                            </a>
                        </li>
                        <li class="nav-item" role="none">
                            <a class="nav-link" href="/authors" role="menuitem">
                                <span class="nav-link-icon d-md-none d-lg-inline-block" aria-hidden="true">
                                    <i class="fas fa-users"></i>
                                </span>
                                <span class="nav-link-title">Authors</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="page-wrapper">
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <div class="page-pretitle">
                            Release Calendar
                        </div>
                        <h2 class="page-title" id="main-content">
                            <i class="fas fa-calendar-alt text-primary me-3" aria-hidden="true"></i>
                            Upcoming Audiobook Releases
                        </h2>
                        <div class="text-muted mt-1">
                            Upcoming audiobooks found from your watchlist searches
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="page-body">
            <div class="container-xl" 
                 id="vue-app" 
                 v-cloak>

        <!-- Control Panel -->
        <section class="row mb-4" aria-labelledby="controls-heading">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" id="controls-heading">Search and Filter Controls</h3>
                        <div class="card-actions" v-show="activeFilters > 0" v-if="activeFilters > 0">
                            <button type="button" 
                                    class="btn btn-sm btn-outline-danger" 
                                    @click="clearAllFilters"
                                    aria-label="Clear all filters">
                                <i class="fas fa-times me-1" aria-hidden="true"></i>
                                Clear All ({{ activeFilters }})
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center g-3">
                            <div class="col-lg-6">
                                <label for="search-input" class="form-label">Search</label>
                                <div class="input-icon">
                                    <span class="input-icon-addon" aria-hidden="true">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" 
                                           id="search-input" 
                                           class="form-control" 
                                           placeholder="Search titles, authors, series, narrators, publishers..."
                                           aria-describedby="search-help"
                                           v-model="filters.search"
                                           @input="debounceApplyFilters"
                                           @keydown.esc="clearSearch"
                                           @keydown.enter.prevent="applyFilters">
                                </div>
                                <div id="search-help" class="form-text">
                                    Use Ctrl+F to quickly focus the search field • Press Escape to clear
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <label for="author-filter" class="form-label">Filter by Author</label>
                                <select id="author-filter" 
                                        class="form-select" 
                                        aria-describedby="author-filter-help"
                                        v-model="filters.author"
                                        @change="applyFilters">
                                    <option value="">All Authors</option>
                                    <option v-for="author in availableAuthors" :key="author" :value="author">
                                        {{ author }}
                                    </option>
                                </select>
                                <div id="author-filter-help" class="form-text">
                                    Filter books by specific author
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <label for="date-range-filter" class="form-label">Filter by Date Range</label>
                                <select id="date-range-filter" 
                                        class="form-select" 
                                        aria-describedby="date-filter-help"
                                        v-model="filters.dateRange"
                                        @change="applyFilters">
                                    <option value="">All Dates</option>
                                    <option value="this-week">This Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="next-3-months">Next 3 Months</option>
                                </select>
                                <div id="date-filter-help" class="form-text">
                                    Filter by release date range
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

                <!-- Statistics Cards -->
                <section class="row row-deck row-cards mb-4" id="stats-cards" aria-labelledby="stats-heading">
                    <h3 class="sr-only" id="stats-heading">Statistics Overview</h3>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-info text-white avatar" aria-hidden="true">
                                            <i class="fas fa-calendar-alt"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="upcoming-books" aria-label="Number of upcoming books">
                                            {{ stats.upcoming_books }}
                                        </div>
                                        <div class="text-muted">
                                            Upcoming Books
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-success text-white avatar" aria-hidden="true">
                                            <i class="fas fa-users"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="total-authors" aria-label="Number of authors">
                                            {{ stats.total_authors }}
                                        </div>
                                        <div class="text-muted">
                                            Authors
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-warning text-white avatar" aria-hidden="true">
                                            <i class="fas fa-building"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="total-publishers" aria-label="Number of publishers">
                                            {{ stats.total_publishers }}
                                        </div>
                                        <div class="text-muted">
                                            Publishers
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-danger text-white avatar" aria-hidden="true">
                                            <i class="fas fa-plus-circle"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium" id="recent-additions" aria-label="Books added this week">
                                            {{ stats.recent_additions }}
                                        </div>
                                        <div class="text-muted">
                                            Added This Week
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Search Results Header -->
                <section class="search-results-header" id="search-results-header" style="display: none;" aria-labelledby="results-heading">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="search-results-count">
                                    <h3 class="h5 mb-0" id="results-heading">
                                        <span id="results-count" aria-live="polite">0</span> books found
                                    </h3>
                                </div>
                                <div class="text-muted small">
                                    Use the controls below to sort and filter results
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- View Mode Toggle -->
                <section class="mb-3" aria-labelledby="view-mode-heading">
                    <h3 class="sr-only" id="view-mode-heading">View Mode Selection</h3>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group" role="group" aria-label="Choose view mode">
                            <button type="button" 
                                    class="btn"
                                    :class="viewMode === 'grid' ? 'btn-primary' : 'btn-outline-primary'"
                                    @click="setViewMode('grid')" 
                                    aria-label="Grid view">
                                <i class="fas fa-th" aria-hidden="true"></i>
                                <span class="d-none d-md-inline ms-1">Grid</span>
                            </button>
                            <button type="button" 
                                    class="btn"
                                    :class="viewMode === 'list' ? 'btn-primary' : 'btn-outline-primary'"
                                    @click="setViewMode('list')" 
                                    aria-label="List view">
                                <i class="fas fa-list" aria-hidden="true"></i>
                                <span class="d-none d-md-inline ms-1">List</span>
                            </button>
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="main-sort-select" class="form-label me-2 mb-0">Sort by:</label>
                            <select id="main-sort-select" 
                                    class="form-select form-select-sm" 
                                    style="width: auto;" 
                                    aria-label="Sort audiobooks by"
                                    v-model="sortBy"
                                    @change="applySorting">
                                <option value="release_date">Release Date</option>
                                <option value="author">Author</option>
                                <option value="title">Title</option>
                                <option value="series">Series</option>
                            </select>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-secondary ms-2" 
                                    @click="toggleSortOrder"
                                    :aria-label="sortOrder === 'asc' ? 'Sort descending' : 'Sort ascending'"
                                    :title="sortOrder === 'asc' ? 'Sort descending' : 'Sort ascending'">
                                <i :class="sortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'" 
                                   aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Results Summary -->
                <div class="mb-3" v-show="(filteredBooks.length > 0 && !isLoading) || isLoading">
                    <div class="alert alert-info mb-3" role="status" aria-live="polite">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <span v-if="isLoading"><i class="fas fa-spinner fa-spin me-2"></i>Loading audiobooks...</span>
                                <span v-else-if="!isLoading && filteredBooks.length > 0">
                                    Showing <strong>{{ filteredBooks.length }}</strong> 
                                    of <strong>{{ allBooks.length }}</strong> upcoming audiobooks
                                    <span v-if="activeFilters > 0" class="text-muted">• {{ activeFilters }} filter(s) active</span>
                                </span>
                            </span>
                            <button v-if="!isLoading && activeFilters > 0" 
                                    type="button" 
                                    class="btn btn-sm btn-outline-danger" 
                                    @click="clearAllFilters">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Audiobooks Container -->
                <main id="audiobooks-container" 
                      role="main" 
                      aria-labelledby="audiobooks-heading"
                      aria-live="polite"
                      :aria-busy="isLoading">
                    <h3 class="sr-only" id="audiobooks-heading">Upcoming Audiobooks</h3>
                    
                    <!-- Loading State -->
                    <div v-show="isLoading" class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="text-muted">Loading upcoming audiobooks...</p>
                    </div>

                    <!-- Grid View -->
                    <div v-show="!isLoading && viewMode === 'grid' && filteredBooks.length > 0" 
                         class="row row-cards">
                        <div v-for="(book, index) in filteredBooks" :key="book.id || index" class="col-lg-4 col-md-6 col-sm-12">
                                <article class="card h-100 audiobook-card" 
                                         tabindex="0" 
                                         role="article" 
                                         :aria-labelledby="`book-title-${index}`">
                                    <!-- Card content will be rendered by Vue -->
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 text-primary">{{ book.author_name || book.author }}</h6>
                                        <div class="btn-group d-flex gap-2 align-items-center">
                                            <span v-if="isNewRelease(book.release_date)" class="badge bg-danger">This Week</span>
                                            <span v-else-if="isComingSoon(book.release_date)" class="badge bg-warning">This Month</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-4">
                                                <div class="book-cover mb-3">
                                                    <img :src="book.cover_url || book.image_url || '/static/images/og-image.png'" 
                                                         :alt="`Cover of ${book.title}`" 
                                                         class="book-cover-img"
                                                         loading="lazy"
                                                         @error="handleImageError"
                                                         @load="handleImageLoad">
                                                </div>
                                            </div>
                                            <div class="col-8">
                                                <h5 class="card-title" :id="`book-title-${index}`">{{ book.title }}</h5>
                                                
                                                <!-- Series Information -->
                                                <p v-if="book.series" class="text-muted mb-2">
                                                    <i class="fas fa-list me-1"></i>
                                                    {{ book.series }}
                                                    <span v-if="book.series_sequence || book.series_number">#{{ book.series_sequence || book.series_number }}</span>
                                                </p>
                                                
                                                <!-- Narrator Information -->
                                                <p v-if="book.narrator" class="text-muted mb-2">
                                                    <i class="fas fa-microphone me-1"></i>
                                                    {{ book.narrator }}
                                                </p>
                                                
                                                <!-- Publisher Information -->
                                                <p v-if="book.publisher_name || book.publisher" class="text-muted mb-2">
                                                    <i class="fas fa-building me-1"></i>
                                                    {{ book.publisher_name || book.publisher }}
                                                </p>
                                                
                                                <!-- Release Information -->
                                                <div class="release-info">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <i class="fas fa-calendar-day text-primary me-2"></i>
                                                        <span class="fw-bold">{{ formatDate(book.release_date) }}</span>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-clock text-muted me-2"></i>
                                                        <span class="text-muted">{{ getTimeToRelease(book.release_date) }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Description/Summary -->
                                        <div v-if="book.merchandising_summary" class="mt-3">
                                            <p class="card-text text-muted small">
                                                {{ book.merchandising_summary.length > 150 ? book.merchandising_summary.substring(0, 150) + '...' : book.merchandising_summary }}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Card Footer with Actions -->
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <span v-if="book.last_checked">Updated: {{ formatDate(book.last_checked) }}</span>
                                            </small>
                                            <div class="btn-group btn-group-sm">
                                                <a v-if="book.link" 
                                                   :href="book.link" 
                                                   target="_blank" 
                                                   rel="noopener noreferrer"
                                                   class="btn btn-outline-primary btn-sm"
                                                   :aria-label="`View ${book.title} on Audible`">
                                                    <i class="fas fa-external-link-alt me-1"></i>
                                                    <span class="d-none d-md-inline">View</span>
                                                </a>
                                                <a v-if="book.asin" 
                                                   :href="`/api/ical/download/${book.asin}`" 
                                                   download
                                                   class="btn btn-outline-success btn-sm"
                                                   :aria-label="`Download calendar event for ${book.title}`">
                                                    <i class="fas fa-calendar-plus me-1"></i>
                                                    <span class="d-none d-md-inline">iCal</span>
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-outline-secondary btn-sm"
                                                        @click="showBookDetails(book)"
                                                        :aria-label="`Show details for ${book.title}`">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <span class="d-none d-md-inline">Details</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            </div>
                    </div>

                    <!-- List View -->
                    <div v-show="!isLoading && viewMode === 'list' && filteredBooks.length > 0" 
                         class="list-group">
                        <article v-for="(book, index) in filteredBooks" :key="book.id || index"
                                 class="list-group-item" 
                                 role="listitem" 
                                 tabindex="0" 
                                 :aria-labelledby="`book-title-list-${index}`">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <img :src="book.cover_url || book.image_url || '/static/images/og-image.png'" 
                                             :alt="`Cover of ${book.title}`" 
                                             style="width: 60px; height: 60px; object-fit: cover;" 
                                             class="rounded"
                                             loading="lazy"
                                             @error="handleImageError"
                                             @load="handleImageLoad">
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-1" :id="`book-title-list-${index}`">{{ book.title }}</h6>
                                        <p class="mb-1 text-muted">{{ book.author_name || book.author }}</p>
                                        
                                        <!-- Series and additional info -->
                                        <div class="mb-1">
                                            <small v-if="book.series" class="text-secondary me-3">
                                                <i class="fas fa-list me-1"></i>
                                                {{ book.series }}
                                                <span v-if="book.series_sequence || book.series_number">#{{ book.series_sequence || book.series_number }}</span>
                                            </small>
                                            
                                            <small v-if="book.narrator" class="text-secondary me-3">
                                                <i class="fas fa-microphone me-1"></i>
                                                {{ book.narrator }}
                                            </small>
                                            
                                            <small v-if="book.publisher_name || book.publisher" class="text-secondary">
                                                <i class="fas fa-building me-1"></i>
                                                {{ book.publisher_name || book.publisher }}
                                            </small>
                                        </div>
                                        
                                        <!-- Description preview -->
                                        <small v-if="book.merchandising_summary" class="text-muted d-block">
                                            {{ book.merchandising_summary.length > 100 ? book.merchandising_summary.substring(0, 100) + '...' : book.merchandising_summary }}
                                        </small>
                                    </div>
                                    <div class="col-auto">
                                        <div class="d-flex flex-column align-items-end">
                                            <span class="badge bg-primary mb-1">{{ formatDate(book.release_date) }}</span>
                                            <div class="text-muted small mb-2">{{ getTimeToRelease(book.release_date) }}</div>
                                            
                                            <!-- Action buttons -->
                                            <div class="btn-group btn-group-sm">
                                                <a v-if="book.link"
                                                   :href="book.link" 
                                                   target="_blank" 
                                                   rel="noopener noreferrer"
                                                   class="btn btn-outline-primary btn-sm"
                                                   :aria-label="`View ${book.title} on Audible`">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                                <a v-if="book.asin"
                                                   :href="`/api/ical/download/${book.asin}`" 
                                                   download
                                                   class="btn btn-outline-success btn-sm"
                                                   :aria-label="`Download calendar event for ${book.title}`">
                                                    <i class="fas fa-calendar-plus"></i>
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-outline-secondary btn-sm"
                                                        @click="showBookDetails(book)"
                                                        :aria-label="`Show details for ${book.title}`">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </article>
                    </div>
                    </div>

                    <!-- Empty State -->
                    <div v-show="!isLoading && filteredBooks.length === 0" 
                         class="empty" 
                         role="status">
                        <div class="empty-icon" aria-hidden="true">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h3 class="empty-title">
                            <span v-if="activeFilters > 0">No audiobooks match your filters</span>
                            <span v-else>No upcoming audiobooks found</span>
                        </h3>
                        <p class="empty-subtitle text-muted">
                            <span v-if="activeFilters > 0">Try adjusting your search criteria or clearing filters.</span>
                            <span v-else>Check your configuration or wait for the next search cycle.</span>
                        </p>
                        <div class="empty-action">
                            <button v-if="activeFilters > 0" class="btn btn-primary" @click="clearAllFilters">
                                <i class="fas fa-times me-2" aria-hidden="true"></i>Clear All Filters
                            </button>
                            <a v-else href="/authors" class="btn btn-primary">
                                <i class="fas fa-cog me-2" aria-hidden="true"></i>Configure Watchlist
                            </a>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" aria-hidden="true" role="status">
        <div class="d-flex flex-column align-items-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading upcoming audiobooks...</span>
            </div>
            <div class="text-muted">Loading upcoming audiobooks...</div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" aria-live="polite" aria-atomic="true">
        <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Audiobook Stalkerr</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close notification"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Message will be set by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Screen Reader Only Announcements -->
    <div aria-live="polite" aria-atomic="true" class="sr-only" id="sr-announcements"></div>

    <!-- Scripts -->
    <!-- jQuery (required for DataTables and other components) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Tabler JS (includes Bootstrap) -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    
    <!-- Vue 3 - Progressive JavaScript Framework -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Core Application Architecture -->
    <script src="/static/js/core/app-core.js"></script>
    <script src="/static/js/core/module-registry.js"></script>
    
    <!-- Core Modules -->
    <script src="/static/js/core/state.js"></script>
    <script src="/static/js/core/api-clean.js"></script>
    
    <!-- UI Modules -->
    <script src="/static/js/modules/toast-clean.js"></script>
    <script src="/static/js/modules/theme-clean.js"></script>
    <script src="/static/js/modules/search-clean.js"></script>
    <script src="/static/js/modules/filters-clean.js"></script>
    <script src="/static/js/modules/modals-clean.js"></script>
    <script src="/static/js/modules/alpine-integration.js"></script>
    <script src="/static/js/modules/upcoming-clean.js"></script>
    
    <!-- Application Bootstrap -->
    <script src="/static/js/bootstrap.js"></script>

    <!-- Initialize app data -->
    <script>
        // Pass initial data from server
        window.upcomingAudiobooks = JSON.parse('{{ upcoming_audiobooks|tojson|safe }}');
        window.initialStats = JSON.parse('{{ stats|tojson|safe }}');
        
        // Vue 3 application for the upcoming page
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        
        const upcomingApp = createApp({
            setup() {
                // Reactive data
                const allBooks = ref(window.upcomingAudiobooks || []);
                const filteredBooks = ref([]);
                const availableAuthors = ref([]);
                const isLoading = ref(false);
                
                // View state
                const viewMode = ref('grid');
                const sortBy = ref('release_date');
                const sortOrder = ref('asc');
                
                // Filters
                const filters = ref({
                    search: '',
                    author: '',
                    dateRange: ''
                });
                
                // Computed values
                const activeFilters = computed(() => {
                    return Object.values(filters.value).filter(value => 
                        value && value.toString().trim() !== ''
                    ).length;
                });
                
                // Debounce helper
                let searchTimeout = null;
                const debounceApplyFilters = () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyFilters, 300);
                };
                
                // Initialize
                const init = () => {
                    console.log('Vue 3 initializing with data:', window.upcomingAudiobooks);
                    console.log('All books length:', allBooks.value.length);
                    
                    // Start with loading state if no data
                    if (!allBooks.value || allBooks.value.length === 0) {
                        console.log('No books found, setting isLoading to false to show empty state');
                        isLoading.value = false;
                    } else {
                        isLoading.value = false;
                    }
                    
                    processData();
                    applyFilters();
                    
                    // Set up keyboard shortcuts
                    setupKeyboardShortcuts();
                    
                    // Listen for refresh events
                    document.addEventListener('refresh-data', () => {
                        refreshData();
                    });
                    
                    console.log('Vue 3 initialized for upcoming page');
                    console.log('Books loaded:', allBooks.value.length);
                    console.log('Filtered books:', filteredBooks.value.length);
                    console.log('Is loading:', isLoading.value);
                };
                
                // Data processing
                const processData = () => {
                    try {
                        // Ensure allBooks is an array
                        if (!Array.isArray(allBooks.value)) {
                            console.warn('allBooks is not an array, initializing as empty array');
                            allBooks.value = [];
                        }
                        
                        // Extract unique authors for filter dropdown
                        const authors = [...new Set(allBooks.value.map(book => book.author_name || book.author))];
                        availableAuthors.value = authors.filter(Boolean).sort();
                        
                        // Initialize filtered books
                        filteredBooks.value = [...allBooks.value];
                        
                        console.log(`Processed ${allBooks.value.length} books, ${availableAuthors.value.length} unique authors`);
                    } catch (error) {
                        console.error('Error processing data:', error);
                        allBooks.value = [];
                        filteredBooks.value = [];
                        availableAuthors.value = [];
                    }
                };
                
                // Filtering
                const applyFilters = () => {
                    try {
                        let filtered = [...allBooks.value];
                        
                        // Search filter
                        if (filters.value.search && filters.value.search.trim()) {
                            const search = filters.value.search.toLowerCase().trim();
                            filtered = filtered.filter(book => {
                                const searchableText = [
                                    book.title || '',
                                    book.author_name || book.author || '',
                                    book.series || '',
                                    book.narrator || '',
                                    book.publisher_name || book.publisher || '',
                                    book.description || '',
                                    book.merchandising_summary || '',
                                    book.asin || ''
                                ].join(' ').toLowerCase();
                                
                                return searchableText.includes(search);
                            });
                        }
                        
                        // Author filter
                        if (filters.value.author) {
                            filtered = filtered.filter(book => 
                                (book.author_name || book.author) === filters.value.author
                            );
                        }
                        
                        // Date range filter
                        if (filters.value.dateRange) {
                            const now = new Date();
                            filtered = filtered.filter(book => {
                                try {
                                    const releaseDate = new Date(book.release_date);
                                    
                                    // Skip invalid dates
                                    if (isNaN(releaseDate.getTime())) {
                                        return false;
                                    }
                                    
                                    switch (filters.value.dateRange) {
                                        case 'this-week':
                                            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                                            return releaseDate >= now && releaseDate <= weekFromNow;
                                        case 'this-month':
                                            const monthFromNow = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());
                                            return releaseDate >= now && releaseDate <= monthFromNow;
                                        case 'next-3-months':
                                            const threeMonthsFromNow = new Date(now.getFullYear(), now.getMonth() + 3, now.getDate());
                                            return releaseDate >= now && releaseDate <= threeMonthsFromNow;
                                        default:
                                            return true;
                                    }
                                } catch (error) {
                                    console.warn('Error filtering by date for book:', book.title, error);
                                    return false;
                                }
                            });
                        }
                        
                        filteredBooks.value = filtered;
                        applySorting();
                        
                        // Notify existing modules if needed
                        if (window.core) {
                            window.core.emit('books:filtered', {
                                total: allBooks.value.length,
                                filtered: filteredBooks.value.length,
                                filters: filters.value
                            });
                        }
                    } catch (error) {
                        console.error('Error applying filters:', error);
                        // Fallback to showing all books
                        filteredBooks.value = [...allBooks.value];
                    }
                };
                
                // Sorting
                const applySorting = () => {
                    filteredBooks.value.sort((a, b) => {
                        let valueA, valueB;
                        
                        switch (sortBy.value) {
                            case 'title':
                                valueA = a.title || '';
                                valueB = b.title || '';
                                break;
                            case 'author':
                                valueA = a.author_name || a.author || '';
                                valueB = b.author_name || b.author || '';
                                break;
                            case 'series':
                                valueA = a.series || '';
                                valueB = b.series || '';
                                break;
                            case 'release_date':
                            default:
                                valueA = new Date(a.release_date);
                                valueB = new Date(b.release_date);
                                break;
                        }
                        
                        let comparison = 0;
                        if (valueA < valueB) comparison = -1;
                        if (valueA > valueB) comparison = 1;
                        
                        return sortOrder.value === 'desc' ? -comparison : comparison;
                    });
                };
                
                // Actions
                const setViewMode = (mode) => {
                    viewMode.value = mode;
                    
                    // Notify existing modules
                    if (window.core) {
                        window.core.emit('view:changed', mode);
                    }
                };
                
                const toggleSortOrder = () => {
                    sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';
                    applySorting();
                };
                
                const clearSearch = () => {
                    filters.value.search = '';
                    applyFilters();
                };
                
                const clearAllFilters = () => {
                    filters.value.search = '';
                    filters.value.author = '';
                    filters.value.dateRange = '';
                    applyFilters();
                };
                
                // Utility methods
                const formatDate = (dateString) => {
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) {
                            return 'Invalid Date';
                        }
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    } catch (error) {
                        console.warn('Error formatting date:', dateString, error);
                        return 'Unknown Date';
                    }
                };
                
                const getTimeToRelease = (dateString) => {
                    try {
                        const releaseDate = new Date(dateString);
                        if (isNaN(releaseDate.getTime())) {
                            return 'Unknown';
                        }
                        
                        const now = new Date();
                        const diffTime = releaseDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays < 0) return 'Released';
                        if (diffDays === 0) return 'Today';
                        if (diffDays === 1) return 'Tomorrow';
                        if (diffDays < 7) return `${diffDays} days`;
                        if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks`;
                        return `${Math.ceil(diffDays / 30)} months`;
                    } catch (error) {
                        console.warn('Error calculating time to release:', dateString, error);
                        return 'Unknown';
                    }
                };
                
                const isNewRelease = (dateString) => {
                    try {
                        const releaseDate = new Date(dateString);
                        if (isNaN(releaseDate.getTime())) return false;
                        
                        const now = new Date();
                        const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        return releaseDate >= now && releaseDate <= weekFromNow;
                    } catch (error) {
                        return false;
                    }
                };
                
                const isComingSoon = (dateString) => {
                    try {
                        const releaseDate = new Date(dateString);
                        if (isNaN(releaseDate.getTime())) return false;
                        
                        const now = new Date();
                        const monthFromNow = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());
                        return releaseDate >= now && releaseDate <= monthFromNow;
                    } catch (error) {
                        return false;
                    }
                };
                
                // Image handling
                const handleImageError = (event) => {
                    const img = event.target;
                    if (img.src !== '/static/images/og-image.png') {
                        img.src = '/static/images/og-image.png';
                        console.warn('Failed to load book cover, using fallback:', img.alt);
                    }
                };
                
                const handleImageLoad = (event) => {
                    // Optional: Track successful image loads for analytics
                    const img = event.target;
                    img.classList.add('loaded');
                };
                
                // Book details modal
                const showBookDetails = (book) => {
                    // Create a detailed view of the book information
                    const detailsContent = `
                        <div class="book-details-modal">
                            <div class="row">
                                <div class="col-md-4">
                                    <img src="${book.cover_url || book.image_url || '/static/images/og-image.png'}" 
                                         alt="Cover of ${book.title}" 
                                         class="img-fluid rounded">
                                </div>
                                <div class="col-md-8">
                                    <h3>${book.title}</h3>
                                    <p class="text-muted mb-3">by ${book.author_name || book.author}</p>
                                    
                                    ${book.series ? `<p><strong>Series:</strong> ${book.series}${book.series_sequence || book.series_number ? ` #${book.series_sequence || book.series_number}` : ''}</p>` : ''}
                                    ${book.narrator ? `<p><strong>Narrator:</strong> ${book.narrator}</p>` : ''}
                                    ${book.publisher_name || book.publisher ? `<p><strong>Publisher:</strong> ${book.publisher_name || book.publisher}</p>` : ''}
                                    <p><strong>Release Date:</strong> ${formatDate(book.release_date)} (${getTimeToRelease(book.release_date)})</p>
                                    ${book.asin ? `<p><strong>ASIN:</strong> ${book.asin}</p>` : ''}
                                    ${book.last_checked ? `<p><strong>Last Updated:</strong> ${formatDate(book.last_checked)}</p>` : ''}
                                    
                                    ${book.merchandising_summary ? `<div class="mt-3"><h5>Description</h5><p>${book.merchandising_summary}</p></div>` : ''}
                                    
                                    <div class="mt-4">
                                        ${book.link ? `<a href="${book.link}" target="_blank" rel="noopener noreferrer" class="btn btn-primary me-2">View on Audible</a>` : ''}
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Use the existing modal system if available
                    if (window.core && window.core.get('modals')) {
                        window.core.get('modals').showModal('Book Details', detailsContent);
                    } else {
                        // Fallback: create a simple alert with key information
                        const simpleDetails = [
                            `Title: ${book.title}`,
                            `Author: ${book.author_name || book.author}`,
                            book.series ? `Series: ${book.series}${book.series_sequence || book.series_number ? ` #${book.series_sequence || book.series_number}` : ''}` : '',
                            book.narrator ? `Narrator: ${book.narrator}` : '',
                            book.publisher_name || book.publisher ? `Publisher: ${book.publisher_name || book.publisher}` : '',
                            `Release Date: ${formatDate(book.release_date)} (${getTimeToRelease(book.release_date)})`,
                            book.merchandising_summary ? `\nDescription: ${book.merchandising_summary}` : ''
                        ].filter(Boolean).join('\n');
                        
                        alert(simpleDetails);
                    }
                };
                
                // Data refresh
                const refreshData = async () => {
                    isLoading.value = true;
                    try {
                        // Emit event to traditional modules
                        if (window.core) {
                            window.core.emit('upcoming:refresh');
                        }
                        
                        // You can add API call here if needed
                        // const response = await fetch('/api/upcoming');
                        // const data = await response.json();
                        // window.upcomingAudiobooks = data.audiobooks;
                        // allBooks.value = data.audiobooks || [];
                        
                        // For now, just refresh with current data
                        processData();
                        applyFilters();
                        
                        console.log('Data refreshed successfully');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                const setupKeyboardShortcuts = () => {
                    document.addEventListener('keydown', (e) => {
                        // Ctrl+F to focus search (prevent default browser search)
                        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                            e.preventDefault();
                            const searchInput = document.getElementById('search-input');
                            if (searchInput) {
                                searchInput.focus();
                                searchInput.select();
                            }
                        }
                        
                        // Escape to clear search when search is focused
                        if (e.key === 'Escape' && document.activeElement?.id === 'search-input') {
                            clearSearch();
                            document.getElementById('search-input')?.blur();
                        }
                        
                        // Alt+G for grid view, Alt+L for list view
                        if (e.altKey && e.key === 'g') {
                            e.preventDefault();
                            setViewMode('grid');
                        }
                        if (e.altKey && e.key === 'l') {
                            e.preventDefault();
                            setViewMode('list');
                        }
                    });
                };
                
                // Vue lifecycle
                onMounted(() => {
                    init();
                });
                
                // Return all reactive data and methods
                return {
                    // Data
                    allBooks,
                    filteredBooks,
                    availableAuthors,
                    isLoading,
                    
                    // View state
                    viewMode,
                    sortBy,
                    sortOrder,
                    
                    // Filters
                    filters,
                    activeFilters,
                    
                    // Methods
                    applyFilters,
                    debounceApplyFilters,
                    applySorting,
                    setViewMode,
                    toggleSortOrder,
                    clearSearch,
                    clearAllFilters,
                    formatDate,
                    getTimeToRelease,
                    isNewRelease,
                    isComingSoon,
                    handleImageError,
                    handleImageLoad,
                    showBookDetails,
                    refreshData
                };
            }
        });
        
        // Mount the Vue app
        upcomingApp.mount('#vue-app');
        
        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // The Vue app will handle initialization
            console.log('Upcoming page loaded with Vue 3 integration');
            console.log('Upcoming audiobooks:', window.upcomingAudiobooks?.length || 0);
            console.log('Stats:', window.initialStats);
        });
        
        // Fallback refresh function for non-Vue elements
        window.refreshData = function() {
            // The Vue app will handle refresh through its methods
            if (document.getElementById('vue-app')?.__vue_app__) {
                // Dispatch to Vue app
                document.dispatchEvent(new CustomEvent('refresh-data'));
            } else if (window.core) {
                // Use traditional module system
                window.core.emit('upcoming:refresh');
            } else {
                // Last resort - reload page
                window.location.reload();
            }
        };
            return {
                // Data
                allBooks: window.upcomingAudiobooks || [],
                filteredBooks: [],
                availableAuthors: [],
                isLoading: false,
                
                // View state
                viewMode: 'grid',
                sortBy: 'release_date',
                sortOrder: 'asc',
                
                // Filters
                filters: {
                    search: '',
                    author: '',
                    dateRange: ''
                },
                activeFilters: 0,
                
                // Initialize
                init() {
                    console.log('Alpine.js initializing with data:', window.upcomingAudiobooks);
                    console.log('All books length:', this.allBooks.length);
                    
                    // Start with loading state if no data
                    if (!this.allBooks || this.allBooks.length === 0) {
                        console.log('No books found, setting isLoading to false to show empty state');
                        this.isLoading = false;
                    } else {
                        this.isLoading = false;
                    }
                    
                    this.processData();
                    this.applyFilters();
                    this.calculateActiveFilters();
                    
                    // Set up keyboard shortcuts
                    this.setupKeyboardShortcuts();
                    
                    // Listen for refresh events
                    document.addEventListener('refresh-data', () => {
                        this.refreshData();
                    });
                    
                    console.log('Alpine.js initialized for upcoming page');
                    console.log('Books loaded:', this.allBooks.length);
                    console.log('Filtered books:', this.filteredBooks.length);
                    console.log('Is loading:', this.isLoading);
                },
                
                // Data processing
                processData() {
                    try {
                        // Ensure allBooks is an array
                        if (!Array.isArray(this.allBooks)) {
                            console.warn('allBooks is not an array, initializing as empty array');
                            this.allBooks = [];
                        }
                        
                        // Extract unique authors for filter dropdown
                        const authors = [...new Set(this.allBooks.map(book => book.author_name || book.author))];
                        this.availableAuthors = authors.filter(Boolean).sort();
                        
                        // Initialize filtered books
                        this.filteredBooks = [...this.allBooks];
                        
                        console.log(`Processed ${this.allBooks.length} books, ${this.availableAuthors.length} unique authors`);
                    } catch (error) {
                        console.error('Error processing data:', error);
                        this.allBooks = [];
                        this.filteredBooks = [];
                        this.availableAuthors = [];
                    }
                },
                
                // Filtering
                applyFilters() {
                    try {
                        let filtered = [...this.allBooks];
                        
                        // Search filter
                        if (this.filters.search && this.filters.search.trim()) {
                            const search = this.filters.search.toLowerCase().trim();
                            filtered = filtered.filter(book => {
                                const searchableText = [
                                    book.title || '',
                                    book.author_name || book.author || '',
                                    book.series || '',
                                    book.narrator || '',
                                    book.publisher_name || book.publisher || '',
                                    book.description || '',
                                    book.merchandising_summary || '',
                                    book.asin || ''
                                ].join(' ').toLowerCase();
                                
                                return searchableText.includes(search);
                            });
                        }
                        
                        // Author filter
                        if (this.filters.author) {
                            filtered = filtered.filter(book => 
                                (book.author_name || book.author) === this.filters.author
                            );
                        }
                        
                        // Date range filter
                        if (this.filters.dateRange) {
                            const now = new Date();
                            filtered = filtered.filter(book => {
                                try {
                                    const releaseDate = new Date(book.release_date);
                                    
                                    // Skip invalid dates
                                    if (isNaN(releaseDate.getTime())) {
                                        return false;
                                    }
                                    
                                    switch (this.filters.dateRange) {
                                        case 'this-week':
                                            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                                            return releaseDate >= now && releaseDate <= weekFromNow;
                                        case 'this-month':
                                            const monthFromNow = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());
                                            return releaseDate >= now && releaseDate <= monthFromNow;
                                        case 'next-3-months':
                                            const threeMonthsFromNow = new Date(now.getFullYear(), now.getMonth() + 3, now.getDate());
                                            return releaseDate >= now && releaseDate <= threeMonthsFromNow;
                                        default:
                                            return true;
                                    }
                                } catch (error) {
                                    console.warn('Error filtering by date for book:', book.title, error);
                                    return false;
                                }
                            });
                        }
                        
                        this.filteredBooks = filtered;
                        this.applySorting();
                        this.calculateActiveFilters();
                        
                        // Notify existing modules if needed
                        if (window.core) {
                            window.core.emit('books:filtered', {
                                total: this.allBooks.length,
                                filtered: this.filteredBooks.length,
                                filters: this.filters
                            });
                        }
                    } catch (error) {
                        console.error('Error applying filters:', error);
                        // Fallback to showing all books
                        this.filteredBooks = [...this.allBooks];
                        this.calculateActiveFilters();
                    }
                },
                
                // Sorting
                applySorting() {
                    this.filteredBooks.sort((a, b) => {
                        let valueA, valueB;
                        
                        switch (this.sortBy) {
                            case 'title':
                                valueA = a.title || '';
                                valueB = b.title || '';
                                break;
                            case 'author':
                                valueA = a.author_name || a.author || '';
                                valueB = b.author_name || b.author || '';
                                break;
                            case 'series':
                                valueA = a.series || '';
                                valueB = b.series || '';
                                break;
                            case 'release_date':
                            default:
                                valueA = new Date(a.release_date);
                                valueB = new Date(b.release_date);
                                break;
                        }
                        
                        let comparison = 0;
                        if (valueA < valueB) comparison = -1;
                        if (valueA > valueB) comparison = 1;
                        
                        return this.sortOrder === 'desc' ? -comparison : comparison;
                    });
                },
                
                // Actions
                setViewMode(mode) {
                    this.viewMode = mode;
                    
                    // Notify existing modules
                    if (window.core) {
                        window.core.emit('view:changed', mode);
                    }
                },
                
                toggleSortOrder() {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                    this.applySorting();
                },
                
                clearSearch() {
                    this.filters.search = '';
                    this.applyFilters();
                },
                
                clearAllFilters() {
                    this.filters.search = '';
                    this.filters.author = '';
                    this.filters.dateRange = '';
                    this.applyFilters();
                },
                
                calculateActiveFilters() {
                    this.activeFilters = Object.values(this.filters).filter(value => 
                        value && value.toString().trim() !== ''
                    ).length;
                },
                
                // Utility methods
                formatDate(dateString) {
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) {
                            return 'Invalid Date';
                        }
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    } catch (error) {
                        console.warn('Error formatting date:', dateString, error);
                        return 'Unknown Date';
                    }
                },
                
                getTimeToRelease(dateString) {
                    try {
                        const releaseDate = new Date(dateString);
                        if (isNaN(releaseDate.getTime())) {
                            return 'Unknown';
                        }
                        
                        const now = new Date();
                        const diffTime = releaseDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays < 0) return 'Released';
                        if (diffDays === 0) return 'Today';
                        if (diffDays === 1) return 'Tomorrow';
                        if (diffDays < 7) return `${diffDays} days`;
                        if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks`;
                        return `${Math.ceil(diffDays / 30)} months`;
                    } catch (error) {
                        console.warn('Error calculating time to release:', dateString, error);
                        return 'Unknown';
                    }
                },
                
                isNewRelease(dateString) {
                    try {
                        const releaseDate = new Date(dateString);
                        if (isNaN(releaseDate.getTime())) return false;
                        
                        const now = new Date();
                        const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        return releaseDate >= now && releaseDate <= weekFromNow;
                    } catch (error) {
                        return false;
                    }
                },
                
                isComingSoon(dateString) {
                    try {
                        const releaseDate = new Date(dateString);
                        if (isNaN(releaseDate.getTime())) return false;
                        
                        const now = new Date();
                        const monthFromNow = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());
                        return releaseDate >= now && releaseDate <= monthFromNow;
                    } catch (error) {
                        return false;
                    }
                },
                
                // Image handling
                handleImageError(event) {
                    const img = event.target;
                    if (img.src !== '/static/images/og-image.png') {
                        img.src = '/static/images/og-image.png';
                        console.warn('Failed to load book cover, using fallback:', img.alt);
                    }
                },
                
                handleImageLoad(event) {
                    // Optional: Track successful image loads for analytics
                    const img = event.target;
                    img.classList.add('loaded');
                },
                
                // Book details modal
                showBookDetails(book) {
                    // Create a detailed view of the book information
                    const detailsContent = `
                        <div class="book-details-modal">
                            <div class="row">
                                <div class="col-md-4">
                                    <img src="${book.cover_url || book.image_url || '/static/images/og-image.png'}" 
                                         alt="Cover of ${book.title}" 
                                         class="img-fluid rounded">
                                </div>
                                <div class="col-md-8">
                                    <h3>${book.title}</h3>
                                    <p class="text-muted mb-3">by ${book.author_name || book.author}</p>
                                    
                                    ${book.series ? `<p><strong>Series:</strong> ${book.series}${book.series_sequence || book.series_number ? ` #${book.series_sequence || book.series_number}` : ''}</p>` : ''}
                                    ${book.narrator ? `<p><strong>Narrator:</strong> ${book.narrator}</p>` : ''}
                                    ${book.publisher_name || book.publisher ? `<p><strong>Publisher:</strong> ${book.publisher_name || book.publisher}</p>` : ''}
                                    <p><strong>Release Date:</strong> ${this.formatDate(book.release_date)} (${this.getTimeToRelease(book.release_date)})</p>
                                    ${book.asin ? `<p><strong>ASIN:</strong> ${book.asin}</p>` : ''}
                                    ${book.last_checked ? `<p><strong>Last Updated:</strong> ${this.formatDate(book.last_checked)}</p>` : ''}
                                    
                                    ${book.merchandising_summary ? `<div class="mt-3"><h5>Description</h5><p>${book.merchandising_summary}</p></div>` : ''}
                                    
                                    <div class="mt-4">
                                        ${book.link ? `<a href="${book.link}" target="_blank" rel="noopener noreferrer" class="btn btn-primary me-2">
                                            <i class="fas fa-external-link-alt me-1"></i>View on Audible
                                        </a>` : ''}
                                        ${book.asin ? `<a href="/api/ical/download/${book.asin}" download class="btn btn-success me-2">
                                            <i class="fas fa-calendar-plus me-1"></i>Download iCal
                                        </a>` : ''}
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Use the existing modal system if available
                    if (window.core && window.core.get('modals')) {
                        window.core.get('modals').showModal('Book Details', detailsContent);
                    } else {
                        // Fallback: create a simple alert with key information
                        const simpleDetails = [
                            `Title: ${book.title}`,
                            `Author: ${book.author_name || book.author}`,
                            book.series ? `Series: ${book.series}${book.series_sequence || book.series_number ? ` #${book.series_sequence || book.series_number}` : ''}` : '',
                            book.narrator ? `Narrator: ${book.narrator}` : '',
                            book.publisher_name || book.publisher ? `Publisher: ${book.publisher_name || book.publisher}` : '',
                            `Release Date: ${this.formatDate(book.release_date)} (${this.getTimeToRelease(book.release_date)})`,
                            book.merchandising_summary ? `\nDescription: ${book.merchandising_summary}` : ''
                        ].filter(Boolean).join('\n');
                        
                        alert(simpleDetails);
                    }
                },
                
                // Data refresh
                async refreshData() {
                    this.isLoading = true;
                    try {
                        // Emit event to traditional modules
                        if (window.core) {
                            window.core.emit('upcoming:refresh');
                        }
                        
                        // You can add API call here if needed
                        // const response = await fetch('/api/upcoming');
                        // const data = await response.json();
                        // window.upcomingAudiobooks = data.audiobooks;
                        // this.allBooks = data.audiobooks || [];
                        
                        // For now, just refresh with current data
                        this.processData();
                        this.applyFilters();
                        
                        console.log('Data refreshed successfully');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        // Ctrl+F to focus search (prevent default browser search)
                        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                            e.preventDefault();
                            const searchInput = document.getElementById('search-input');
                            if (searchInput) {
                                searchInput.focus();
                                searchInput.select();
                            }
                        }
                        
                        // Escape to clear search when search is focused
                        if (e.key === 'Escape' && document.activeElement?.id === 'search-input') {
                            this.clearSearch();
                            document.getElementById('search-input')?.blur();
                        }
                        
                        // Alt+G for grid view, Alt+L for list view
                        if (e.altKey && e.key === 'g') {
                            e.preventDefault();
                            this.setViewMode('grid');
                        }
                        if (e.altKey && e.key === 'l') {
                            e.preventDefault();
                            this.setViewMode('list');
                        }
                    });
                }
            }
        }
        
        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // The bootstrap.js will handle initialization
            console.log('Upcoming page loaded with Alpine.js integration');
            console.log('Upcoming audiobooks:', window.upcomingAudiobooks?.length || 0);
            console.log('Stats:', window.initialStats);
        });
        
        // Fallback refresh function for non-Alpine elements
        window.refreshData = function() {
            // Check if Alpine.js is managing the page
            const alpineElement = document.querySelector('[x-data="upcomingPageData()"]');
            if (alpineElement && alpineElement._x_dataStack) {
                // Dispatch to Alpine.js
                document.dispatchEvent(new CustomEvent('refresh-data'));
            } else if (window.core) {
                // Use traditional module system
                window.core.emit('upcoming:refresh');
            } else {
                // Last resort - reload page
                window.location.reload();
            }
        };
    </script>
</body>
</html>
